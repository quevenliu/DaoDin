import Head from "next/head";
import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/router";
import axios from "axios";
import Swal from "sweetalert2";
import Topbar from "@/components/Topbar";
import styles from "../../styles/font.module.scss";
import { getServerCookie } from "../../utils/cookie";

const apiUrl = process.env.API_URL;

export default function JoinGroupPage({ token, groupId }) {
  const [group, setGroup] = useState({});
  const router = useRouter();
  const nicknameRef = useRef("");
  const introRef = useRef("");
  const msgRef = useRef("");

  const config = {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    },
  };

  const resetForm = () => {
    nicknameRef.current.value = "";
    introRef.current.value = "";
    msgRef.current.value = "";
  };

  const getGroup = async () => {
    await axios
      .get(`${apiUrl}/group/${groupId}`, config)
      .then((res) => {
        setGroup(res.data);
      })
      .catch((err) => {
        console.log(err);
        Swal.fire({
          title: `${err.message}\nPlease try again later or notify our engineering team.`,
          padding: "1.2em",
          background: "#fadee5",
          customClass: {
            title: "swal_title",
            confirmButton: "swal_confirm_fail",
            container: "swal_container",
            popup: "swal_popup",
          },
        });
      });
  };

  const joinGroup = async () => {
    const payload = {
      self_intro: introRef.current.value,
      match_msg: msgRef.current.value,
      nickname: nicknameRef.current.value,
    };
    await axios
      .post(`${apiUrl}/group/${groupId}/join`, payload, config)
      .then((res) => {
        console.log(res);
        Swal.fire({
          title: "You'll be notified after getting matched!",
          padding: "1.2em",
          background: "#D1E6D2",
          customClass: {
            title: "swal_title",
            confirmButton: "swal_confirm_success",
            container: "swal_container",
            popup: "swal_popup",
          },
        });
      })
      .catch((err) => {
        console.log(err);
        Swal.fire({
          title: `${err.message}\nPlease try again later or notify our engineering team.`,
          padding: "1.2em",
          background: "#fadee5",
          customClass: {
            title: "swal_title",
            confirmButton: "swal_confirm_fail",
            container: "swal_container",
            popup: "swal_popup",
          },
        });
      });
  };

  const handleJoinGroup = async () => {
    await joinGroup();
    resetForm();
    router.push("/");
  };

  const handleCancel = () => {
    resetForm();
    router.push("/");
  };

  useEffect(() => {
    getGroup();
  });

  return (
    <>
      <Head>
        <title>Join Group {groupId} Page</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta httpEquiv="X-UA-Compatible" content="ie=edge" />
        <meta name="description" content="Generated by create next app" />
      </Head>
      <main
        className={`${styles.content} min-h-screen bg-gradient-to-br from-[#D14444] to-[#F77B54] dark:from-darkPrimaryColor dark:to-darkSecondaryColor lg:p-12 sm:p-6 sm:pt-0 md:p-8 md:pt-0.5 lg:pt-0 p-4 pt-0`}
      >
        <Topbar token={token} />
        <div className="mt-2 sm:mt-3 md:mt-4 lg:mt-5 max-w-[800px] bg-primaryColor dark:bg-darkSecondaryColor text-white m-auto rounded-t-[20px] text-center p-2 md:p-2.5 lg:p-3 text-[22px] md:text-2xl lg:text-[26px] font-bold">
          {group.name || "Mystery Group"}
        </div>
        <div className="max-w-[800px] bg-white m-auto p-4 sm:p-5 md:p-6 lg:p-7 rounded-b-[20px] flex">
          <form className="w-full px-2.5 mb-2 lg:mb-6 flex flex-col justify-between gap-3.5 md:gap-4 lg:gap-4.5">
            <label
              htmlFor="nickname"
              className="text-xl md:text-[22px] lg:text-2xl font-semibold flex flex-col"
            >
              Nickname
              <input
                type="text"
                id="nickname"
                name="nickname"
                className="mt-1 md:mt-1.5 lg:mt-2 py-1 md:py-[5px] px-4 lg:px-5 text-lg lg:text-[19px] font-normal border border-solid border-primaryColor dark:border-darkPrimaryColor rounded-[20px] ring-1 ring-inset ring-primaryColor dark:ring-darkPrimaryColor focus:outline-none focus:ring-2 focus:ring-primaryColor dark:focus:ring-darkPrimaryColor"
                ref={nicknameRef}
              />
            </label>
            <label
              htmlFor="intro"
              className="text-xl md:text-[22px] lg:text-2xl font-semibold flex flex-col"
            >
              Tell me about yourself
              <textarea
                id="intro"
                name="intro"
                rows="6"
                className="mt-1 md:mt-1.5 lg:mt-2 px-4 py-2 lg:px-4.5 text-lg lg:text-xl font-normal border border-solid border-primaryColor dark:border-darkPrimaryColor ring-1 ring-inset ring-primaryColor dark:ring-darkPrimaryColor focus:outline-none focus:ring-2 focus:ring-primaryColor dark:focus:ring-darkPrimaryColor rounded-[20px] resize-none overflow-hidden"
                ref={introRef}
              />
            </label>
            <label
              htmlFor="tendency"
              className="text-xl md:text-[22px] lg:text-2xl font-semibold flex flex-col"
            >
              What kind of people would you like to meet
              <textarea
                id="tendency"
                name="tendency"
                rows="6"
                className="mt-1 md:mt-1.5 lg:mt-2 px-4 py-2 lg:px-4.5 text-lg lg:text-xl font-normal border border-solid border-primaryColor dark:border-darkPrimaryColor ring-1 ring-inset ring-primaryColor dark:ring-darkPrimaryColor focus:outline-none focus:ring-2 focus:ring-primaryColor dark:focus:ring-darkPrimaryColor rounded-[20px] resize-none overflow-hidden"
                ref={msgRef}
              />
            </label>
            <div className="mt-2 self-end flex gap-2 md:gap-2.5 lg:gap-3">
              <button
                type="button"
                className="w-24 md:w-28 lg:w-32 text-center py-1 lg:py-2 text-[22px] md:text-[23px] lg:text-2xl font-semibold text-white bg-[#BFBFBF] rounded-[50px] focus:outline-none focus:ring-2 focus:ring-primaryColor dark:focus:ring-darkPrimaryColor hover:animate-buttonPush"
                onClick={handleCancel}
              >
                Cancel
              </button>
              <button
                type="button"
                className="w-24 md:w-28 lg:w-32 py-1 lg:py-2 text-[22px] md:text-[23px] lg:text-2xl font-semibold text-white bg-primaryColor dark:bg-darkPrimaryColor rounded-[50px] focus:outline-none focus:ring-2 focus:ring-[#BFBFBF] hover:animate-buttonPush"
                onClick={handleJoinGroup}
              >
                Join
              </button>
            </div>
          </form>
        </div>
      </main>
    </>
  );
}

export async function getServerSideProps(context) {
  const token = getServerCookie("userInfo", "token", context.req);
  const groupId = Number(context.params.id);

  if (!token) {
    return {
      redirect: {
        destination: "/login",
        permanent: false,
      },
    };
  }

  return {
    props: { token, groupId },
  };
}
